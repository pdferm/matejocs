<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador — Lletres (Cifres i Lletres)</title>
  <style>
    :root {
      --bg: #0f172a; /* fons fosc */
      --text: #e5e7eb; /* text clar */
      --muted: #9ca3af; /* text suau */
      --accent: #22d3ee; /* cian */
      --accent-2: #a78bfa; /* violeta */
      --warn: #f59e0b; /* ambre */
      --danger: #ef4444; /* roig */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background: radial-gradient(1200px 800px at 20% 0%, #1f2937, #0b1022 60%, var(--bg) 100%); color:var(--text); display:grid; place-items:center; padding:24px; }
    .app { max-width:1040px; width:100%; background:linear-gradient(180deg,#0b1224,#0a1020); border:1px solid #1f2937; border-radius:16px; box-shadow:0 10px 40px #0006; padding:20px; }
    .title { display:flex; align-items:center; gap:10px; font-weight:800; margin:0 0 8px; }
    .title .dot { width:12px; height:12px; border-radius:50%; background:conic-gradient(from 180deg,var(--accent),var(--accent-2)); box-shadow:0 0 16px var(--accent); }
    .subtitle { color:var(--muted); margin:0 0 18px; }

    .controls { display:grid; grid-template-columns: 1fr auto auto; gap:12px; align-items:center; }
    .left { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    select, button, input[type="file"], input[type="text"] { background:#0b1222; color:var(--text); border:1px solid #2b3448; border-radius:12px; padding:10px 14px; font-size:1rem; }
    button { cursor:pointer; transition: transform .04s ease, border-color .2s ease, box-shadow .2s ease; }
    button.primary { background:linear-gradient(180deg,#10324a,#0d2433); }
    button.secondary { background:linear-gradient(180deg,#2a203f,#1e1830); }
    button.sm { padding:6px 10px; font-size:.9rem; border-radius:10px; }
    button:active { transform: translateY(1px); }

    .board { display:grid; grid-template-columns:repeat(9,1fr); gap:10px; margin:18px 0; }
    .tile { aspect-ratio:1/1; display:grid; place-items:center; border-radius:16px; font-weight:900; font-size:clamp(1.1rem,4.5vw,2rem); background:linear-gradient(180deg,#0f1a2c,#0b1321); border:1px solid #1e293b; box-shadow: inset 0 -16px 40px #0006, 0 8px 30px #0006; }

    /* Temporitzador + interruptor (mateixa estètica que xifres) */
    .timer { display:flex; gap:10px; align-items:center; margin-left:auto; }
    .time-select { display:flex; gap:8px; align-items:center; }
    .time-display { font-weight:800; padding:8px 12px; border-radius:10px; border:1px solid #334155; background:#0b1a2a; min-width:96px; text-align:center; transition: opacity .2s ease; }
    .time-display.warn { border-color: var(--warn); color: var(--warn); }
    .time-display.danger { border-color: var(--danger); color: var(--danger); }
    .toggle { display:flex; align-items:center; gap:8px; }
    .toggle input { position:absolute; opacity:0; width:0; height:0; }
    .slider { position:relative; width:44px; height:24px; background:#1f2937; border:1px solid #334155; border-radius:999px; transition: background .2s, border-color .2s; }
    .slider::after { content:""; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#9ca3af; transition: transform .2s, background .2s; }
    .toggle input:checked + .slider { background:#0ea5e9; border-color:#38bdf8; }
    .toggle input:checked + .slider::after { transform: translateX(20px); background:#fff; }

    .tools { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge { padding:6px 10px; border:1px solid #334155; border-radius:999px; color:var(--muted); }
    .help { color:var(--muted); font-size:.9rem; margin-top:10px; }
    .footer { margin-top:18px; display:flex; justify-content:space-between; font-size:.85rem; color:var(--muted); }

    @media (max-width: 1000px) { .board { grid-template-columns: repeat(6,1fr); } }
    @media (max-width: 640px) { .board { grid-template-columns: repeat(3,1fr); } .timer { margin-left:0; } }
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="Simulador del joc Lletres">
    <h1 class="title"><span class="dot" aria-hidden="true"></span> Simulador — Lletres</h1>
    <p class="subtitle">Tria <strong>Vocal</strong> o <strong>Consonant</strong> per a traure lletres (fins a 9). Pots <strong>Sortejar 9</strong> d’una. Activa o desactiva el <strong>temporitzador</strong> amb l’interruptor. Escriu la teua proposta i valida si és formable amb les lletres; si carregues un diccionari, també et mostraré les <strong>millors paraules</strong>.</p>

    <section class="controls" aria-label="Controls">
      <div class="left">
        <button id="addVowelBtn" class="primary">Vocal ➕</button>
        <button id="addConsBtn" class="primary">Consonant ➕</button>
        <button id="drawNineBtn" class="secondary">Sortejar 9</button>
      </div>

      <div class="timer" aria-label="Temporitzador">
        <label class="toggle" for="timerToggle">
          <input type="checkbox" id="timerToggle" checked aria-label="Interruptor del temporitzador" />
          <span class="slider" aria-hidden="true"></span>
          <span>Temporitzador</span>
        </label>
        <div class="time-select">
          <label for="timeSel">Temps:</label>
          <select id="timeSel" aria-label="Duració del temporitzador">
            <option value="45" selected>45 s</option>
            <option value="60">60 s</option>
            <option value="90">90 s</option>
            <option value="120">120 s</option>
          </select>
        </div>
        <div id="timeDisplay" class="time-display" aria-live="polite">00:45</div>
        <button id="startBtn" class="sm" title="Començar comptatge (si no arranca automàticament)">Començar</button>
      </div>

      <div>
        <button id="resetBtn" class="sm" title="Neteja i torna a començar">Netejar</button>
      </div>
    </section>

    <section class="board" id="letters" aria-label="Lletres">
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
      <div class="tile" aria-live="polite">–</div>
    </section>

    <div class="tools">
      <span class="badge">Regles: usa cada lletra com a màxim una vegada · No es permeten accents ni dièresi en el sorteig (pots escriure'ls en la proposta si vols, els ignore per a comprovar).</span>
      <input id="wordInput" type="text" placeholder="La teua paraula…" maxlength="20" />
      <button id="checkBtn" class="sm">Validar paraula</button>
      <select id="languageSelect" title="Tria idioma">
			<option value="Valencia.txt" selected>Valencià</option>
			<option value="Castellano.txt">Castellà</option>
	   </select>
      <button id="solveBtn" class="sm" title="Cerca les millors paraules dins del diccionari carregat">Millors paraules</button>
    </div>

    <p class="help">
      Mecànica clàssica: 9 lletres, tens 45 s per a trobar la paraula més llarga. El temporitzador s’inicia automàticament en traure la 9a lletra (si està activat) o amb el botó <em>Començar</em>.
    </p>

    <div class="footer">
      <span>Fet amb ❤ des de Carlet.</span>
      <span>(c) Raquel i Javi, 2025</span>
    </div>
  </main>

  <script>
    (function(){
      // ======== Configuració de lletres (pesos aproximats per a valencià/català general) ========
      // Vocals més freqüents
      const VOWELS = repeatWeights({ A:14, E:14, I:7, O:8, U:4 });
      // Consonants (s'evita Ñ; s'inclou Ç amb poca freqüència; K/W/Y molt rares)
      const CONS = repeatWeights({ B:2, C:3, Ç:1, D:4, F:2, G:2, H:1, J:1, K:1, L:5, M:3, N:6, P:3, Q:1, R:6, S:6, T:6, V:2, W:1, X:1, Y:1, Z:1 });

      // ======== Estat ========
      let letters = []; // lletres actuals (màx 9)
      let dict = null;  // conjunt de paraules (si es carrega)
      let dictSize = 0;

      // Temporitzador
      let idCrono = null; let fiTemps = null;

      // ======== Elements ========
      const tiles = Array.from(document.querySelectorAll('.tile'));
      const addVowelBtn = document.getElementById('addVowelBtn');
      const addConsBtn = document.getElementById('addConsBtn');
      const drawNineBtn = document.getElementById('drawNineBtn');
      const resetBtn = document.getElementById('resetBtn');
      const startBtn = document.getElementById('startBtn');
      const timeSel = document.getElementById('timeSel');
      const timeDisplay = document.getElementById('timeDisplay');
      const timerToggle = document.getElementById('timerToggle');
      const wordInput = document.getElementById('wordInput');
      const checkBtn = document.getElementById('checkBtn');
      const solveBtn = document.getElementById('solveBtn');
      const dictFile = document.getElementById('dictFile');

      // ======== Utilitats ========
      function repeatWeights(map){
        const arr = [];
        for (const [ch, n] of Object.entries(map)) { for (let i=0;i<n;i++) arr.push(ch); }
        return arr;
      }
      function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
      function pick(arr){ return arr[randInt(0, arr.length-1)]; }
      function anim(el){ el.style.transform='scale(0.9)'; el.style.transition='transform 120ms ease'; requestAnimationFrame(()=>setTimeout(()=>el.style.transform='scale(1)',10)); }
      const normalize = (s) => s.toUpperCase().normalize('NFD').replace(/[^A-ZÇ·]/g,'').replace(/[·]/g,'');

      function render(){
        for (let i=0;i<tiles.length;i++){
          const val = letters[i] ?? '–'; tiles[i].textContent = val; tiles[i].setAttribute('aria-label', `Lletra ${i+1}: ${val}`);
        }
      }
      function clearBoard(){ letters=[]; render(); }

      function addVowel(){ if (letters.length>=9) return; letters.push(pick(VOWELS)); render(); anim(tiles[letters.length-1]); maybeAutoStart(); }
      function addCons(){ if (letters.length>=9) return; letters.push(pick(CONS)); render(); anim(tiles[letters.length-1]); maybeAutoStart(); }
      function drawNine(){ letters = []; for(let i=0;i<9;i++){ letters.push(pick(i<3?VOWELS:[...VOWELS,...CONS])); } // assegura almenys 3 vocals
        render(); tiles.forEach(anim); maybeAutoStart(); }

      // ======== Temporitzador (mateixa lògica) ========
      function formatTime(secs){ const m=Math.floor(secs/60), s=secs%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
      function setTimeDisplay(secs){ const s=Math.max(0,secs); timeDisplay.textContent=formatTime(s); timeDisplay.classList.toggle('warn', s<=15&&s>5); timeDisplay.classList.toggle('danger', s<=5); }
      function stopTimer(){ if(idCrono){ clearInterval(idCrono); idCrono=null; } fiTemps=null; }
      function startTimer(seconds){ stopTimer(); setTimeDisplay(seconds); const now=Date.now(); fiTemps=now+seconds*1000; idCrono=setInterval(()=>{ const remain=Math.ceil((fiTemps-Date.now())/1000); setTimeDisplay(remain); if(remain<=0){ stopTimer(); setTimeDisplay(0); playAlarm(); flashTime(); } },250); }
      function flashTime(){ const el=timeDisplay; let i=0; const f=setInterval(()=>{ el.style.filter=(i%2===0)?'brightness(2)':'brightness(1)'; i++; if(i>8){ clearInterval(f); el.style.filter='brightness(1)'; } },120); }
      function playAlarm(){ try{ const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) throw new Error('AudioContext no dispo'); const ctx=new Ctx(); const o1=ctx.createOscillator(), g1=ctx.createGain(); o1.type='sine'; o1.frequency.value=880; g1.gain.setValueAtTime(0.0001,ctx.currentTime); g1.gain.exponentialRampToValueAtTime(0.4,ctx.currentTime+0.02); g1.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+1.0); o1.connect(g1).connect(ctx.destination); o1.start(); o1.stop(ctx.currentTime+1.05); const o2=ctx.createOscillator(), g2=ctx.createGain(); o2.type='triangle'; o2.frequency.value=660; g2.gain.setValueAtTime(0.0001,ctx.currentTime+0.55); g2.gain.exponentialRampToValueAtTime(0.35,ctx.currentTime+0.6); g2.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+1.6); o2.connect(g2).connect(ctx.destination); o2.start(ctx.currentTime+0.55); o2.stop(ctx.currentTime+1.65);}catch(e){console.warn('Alarma no disponible',e);} }
      function updateTimerUI(){ const on=timerToggle.checked; timeSel.disabled=!on; timeDisplay.style.opacity=on?1:0.3; if(!on) stopTimer(); }
      function maybeAutoStart(){ if(letters.length===9 && timerToggle.checked){ startTimer(parseInt(timeSel.value,10)); } }

      // ======== Validació i solver ========
      function multisetFromLetters(arr){ const m=new Map(); for(const ch of arr){ m.set(ch,(m.get(ch)||0)+1); } return m; }
      function canForm(word, arr){ const target = normalize(word).split(''); const bag = new Map(); for(const ch of arr){ bag.set(ch,(bag.get(ch)||0)+1); }
        for(const ch of target){ const k = ch; const v = (bag.get(k)||0)-1; if(v<0) return false; bag.set(k,v); } return target.length>0; }

      function handleValidate(){ const w = wordInput.value.trim(); if(!w){ alert('Escriu una paraula per a validar.'); return; } if(letters.filter(x=>x!=='–').length===0){ alert('Primer trau lletres.'); return; } const ok = canForm(w, letters); alert(ok ? '✔️ Es pot formar amb les lletres.' : '✖️ No es pot formar amb les lletres actuals.'); }

      <!-- async function handleDictFile(ev){ const file = ev.target.files && ev.target.files[0]; if(!file) return; const text = await file.text(); const lines = text.split(/\r?\n/).map(s=>normalize(s.trim())).filter(Boolean); dict = new Set(lines); dictSize = dict.size; alert(`Diccionari carregat: ${dictSize.toLocaleString()} entrades.`); } -->

      function bestWords(){ if(!dict){ alert('Carrega un diccionari (.txt, una paraula per línia) abans.'); return; } if(letters.length===0){ alert('Primer trau lletres.'); return; }
        const bag = multisetFromLetters(letters);
        const results = [];
        // Itera diccionari i comprova si és formable (eficient prou per a fins didàctics)
        let checked = 0;
        for(const w of dict){ checked++; if(canFormQuick(w, bag)) results.push(w); }
        results.sort((a,b)=> b.length - a.length || a.localeCompare(b,'ca'));
        openResults(results, checked);
      }
      function canFormQuick(word, bag){ // usa còpia local del multiset
        const need = new Map(); for(const ch of word){ need.set(ch,(need.get(ch)||0)+1); }
        for(const [ch, cnt] of need){ if((bag.get(ch)||0) < cnt) return false; }
        return word.length>0;
      }
      function openResults(list, checked){ const top = list.slice(0,500); const lettersStr = letters.join(' ');
        const w = window.open('', '_blank'); if(!w){ alert('El navegador ha blocat la finestra emergent.'); return; }
        const html = `<!DOCTYPE html><html lang="ca"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Millors paraules</title>
<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,\"Helvetica Neue\",Arial;margin:0;background:#0b1020;color:#e5e7eb}
.wrap{max-width:900px;margin:24px auto;padding:0 16px}
.card{background:linear-gradient(180deg,#0f1a2c,#0b1321);border:1px solid #1e293b;border-radius:14px;box-shadow:0 10px 30px #0006;padding:18px}
.badge{padding:6px 10px;border:1px solid #334155;border-radius:999px}
ol{line-height:1.6}
.num{display:inline-grid;place-items:center;min-width:28px;padding:4px 8px;border-radius:8px;background:#0b1a2a;border:1px solid #1e293b;margin-right:6px}
</style></head><body>
<div class=wrap>
  <div class=card>
    <h1>Millors paraules</h1>
    <p class=badge>Lletres: ${lettersStr}</p>
    <p class=badge>Resultats: ${list.length} (revisades ${checked.toLocaleString()} entrades del diccionari)</p>
    ${top.length?'<ol>'+top.map(w=>`<li><span class=num>${w.length}</span> ${w}</li>`).join('')+'</ol>':'<p>No s\'ha trobat cap paraula amb el diccionari carregat.</p>'}
  </div>
</div>
</body></html>`;
        w.document.write(html); w.document.close(); }

      function updateTimerUI(){ const on=timerToggle.checked; timeSel.disabled=!on; timeDisplay.style.opacity=on?1:0.3; startBtn.disabled=!on; if(!on) stopTimer(); }

      // ======== Esdeveniments ========
      addVowelBtn.addEventListener('click', addVowel);
      addConsBtn.addEventListener('click', addCons);
      drawNineBtn.addEventListener('click', ()=>{ letters=[]; for(let i=0;i<9;i++){ letters.push(pick(VOWELS.concat(CONS))); } render(); tiles.forEach(anim); maybeAutoStart(); });
      resetBtn.addEventListener('click', ()=>{ clearBoard(); stopTimer(); setTimeDisplay(parseInt(timeSel.value,10)); });
      startBtn.addEventListener('click', ()=>{ if(timerToggle.checked) startTimer(parseInt(timeSel.value,10)); });
      timeSel.addEventListener('change', ()=>{ if(timerToggle.checked){ stopTimer(); setTimeDisplay(parseInt(timeSel.value,10)); } else { setTimeDisplay(parseInt(timeSel.value,10)); }});
      timerToggle.addEventListener('change', updateTimerUI);

      checkBtn.addEventListener('click', handleValidate);
      // ======== Gestió d'idioma i càrrega de diccionari ========
		const languageSelect = document.getElementById('languageSelect');

		async function loadDictionary(path) {
		  try {
			const response = await fetch(path);
			if (!response.ok) throw new Error(`No s'ha pogut carregar ${path}`);
			const text = await response.text();
			const lines = text.split(/\r?\n/).map(s => normalize(s.trim())).filter(Boolean);
			dict = new Set(lines);
			dictSize = dict.size;
			console.log(`Diccionari carregat (${path}): ${dictSize} paraules.`);
		  } catch (err) {
			alert(`Error carregant el diccionari (${path}). Assegura't que l'arxiu està al mateix directori.`);
			console.error(err);
		  }
		}

		// Canvi d'idioma
		languageSelect.addEventListener('change', (e) => {
		  loadDictionary(e.target.value);
		});

		// Carrega inicial (Valencià per defecte)
		loadDictionary('Valencia.txt');

	  solveBtn.addEventListener('click', bestWords);

      // Tecles ràpides: V (vocal), C (consonant), S (sortejar 9), Espai (començar), L (netejar)
      document.addEventListener('keydown', (e)=>{
        const k = e.key.toLowerCase();
        if (k==='v') addVowel();
        if (k==='c') addCons();
        if (k==='s') drawNineBtn.click();
        if (k===' ') { e.preventDefault(); startBtn.click(); }
        if (k==='l') resetBtn.click();
      });

      // ======== Inicialització ========
      function maybeAutoStart(){ if(letters.length===9 && timerToggle.checked){ startTimer(parseInt(timeSel.value,10)); } }
      function setTimeDisplay(secs){ const s=Math.max(0,secs); timeDisplay.textContent=formatTime(s); timeDisplay.classList.toggle('warn', s<=15&&s>5); timeDisplay.classList.toggle('danger', s<=5); }
      function formatTime(secs){ const m=Math.floor(secs/60), s=secs%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
      render();
      setTimeDisplay(parseInt(timeSel.value,10));
      updateTimerUI();
    })();
  </script>
</body>
</html>
